<template>
  <div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    <Sidebar />

    <!-- Main Content -->
    <div class="flex-1 flex flex-col items-center justify-center relative">
      <div class="brand">
        <img src="/images/school_logo.png" alt="School Logo" class="school-logo" />
        <h1>DocuNet</h1>
      </div>

      <div 
        class="upload-container" 
        :class="{ dragging: isDragging }"
        @dragover.prevent="handleDragOver"
        @dragleave="handleDragLeave"
        @drop="handleDrop"
      >
        <div class="upload-box bg-white p-10 rounded-lg shadow-lg text-center">
          <i class="bi bi-cloud-arrow-up-fill upload-icon"></i>
          <h2 class="text-xl font-bold mt-4">Drag and drop your files</h2>
          <p class="text-gray-500 text-sm mt-2">Any file type is supported</p>
          <p class="text-gray-500 text-sm mt-2">Or</p>
          <input type="file" id="fileInput" class="hidden" multiple @change="handleFileUpload" accept="*/*">
          <button @click="browseFile" class="mt-4 px-6 py-2 border-2 border-indigo-900 text-indigo-900 font-bold rounded-lg hover:bg-indigo-900 hover:text-white">
            Browse files
          </button>
        </div>

        <div v-if="selectedFiles.length" class="selected-files bg-white p-4 rounded-lg shadow-lg">
          <p class="text-gray-700 font-bold">Selected Files:</p>
          <ul class="file-list">
            <li v-for="(file, index) in selectedFiles" :key="index" class="text-gray-700 flex items-center justify-between border-b py-2">
              <span>{{ file.name }} ({{ formatFileSize(file.size) }})</span>
              <button @click="removeFile(index)" class="text-red-500 hover:text-red-700">
                <i class="bi bi-trash"></i>
              </button>
            </li>
          </ul>
        </div>

        <button 
          v-if="selectedFiles.length" 
          @click="uploadFiles" 
          class="upload-btn"
          :disabled="isUploading"
        >
          {{ isUploading ? 'Uploading...' : 'Upload Document' }}
        </button>

        <!-- Styled Success Message -->
        <p v-if="uploadMessage" class="mt-4 p-2 text-green-700 bg-green-100 border border-green-400 rounded-lg shadow-md">
          {{ uploadMessage }}
        </p>
      </div>
    </div>
  </div>
</template>

<script>
import { router } from '@inertiajs/vue3';
import Sidebar from "@/Components/Sidebar.vue";

export default {
  components: { Sidebar },
  name: "Upload",
  data() {
    return {
      selectedFiles: [],
      isDragging: false,
      isUploading: false,
      uploadMessage: "",
    };
  },
  methods: {
    browseFile() {
      document.getElementById("fileInput").click();
    },
    handleFileUpload(event) {
      const newFiles = Array.from(event.target.files);
      this.addFiles(newFiles);
    },
    removeFile(index) {
      this.selectedFiles.splice(index, 1);
    },
    handleDragOver(event) {
      event.preventDefault();
      this.isDragging = true;
    },
    handleDragLeave() {
      this.isDragging = false;
    },
    handleDrop(event) {
      event.preventDefault();
      this.isDragging = false;
      const droppedFiles = Array.from(event.dataTransfer.files);
      this.addFiles(droppedFiles);
    },
    addFiles(files) {
      files.forEach(file => {
        if (!this.selectedFiles.some(existingFile => existingFile.name === file.name)) {
          this.selectedFiles.push(file);
        }
      });
    },
    formatFileSize(size) {
      if (size < 1024) return `${size} B`;
      if (size < 1024 * 1024) return `${(size / 1024).toFixed(2)} KB`;
      return `${(size / (1024 * 1024)).toFixed(2)} MB`;
    },
    async uploadFiles() {
  if (this.selectedFiles.length === 0) return;

  this.isUploading = true;
  this.uploadMessage = "";
  const formData = new FormData();

  this.selectedFiles.forEach((file) => {
    formData.append('files[]', file);
  });

  try {
    await router.post('/upload', formData, {
      forceFormData: true,
      onSuccess: () => {
        this.selectedFiles = [];
        this.isUploading = false;
        this.uploadMessage = "🎉 Your files have been uploaded successfully! 🚀";

        // Automatically remove the message after 3 seconds
        setTimeout(() => {
          this.uploadMessage = "";
        }, 3000);
      },
      onError: () => {
        this.isUploading = false;
        this.uploadMessage = "⚠️ Upload failed. Please try again.";

        // Hide the error message after 3 seconds
        setTimeout(() => {
          this.uploadMessage = "";
        }, 3000);
      }
    });
  } catch (error) {
    this.isUploading = false;
    this.uploadMessage = "❌ An error occurred while uploading.";

    // Hide the error message after 3 seconds
    setTimeout(() => {
      this.uploadMessage = "";
    }, 3000);
  }
}
  }
};
</script>

<style scoped>
.upload-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.upload-box {
  width: 700px;
  margin-left: 300px;
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 3px dashed #ccc;
  transition: border-color 0.3s ease;
}

.upload-box:hover,
.upload-container.dragging .upload-box {
  border-color: #2563eb;
}

.selected-files {
  width: 700px;
  margin-left: 300px;
  max-height: 120px;
  overflow-y: auto;
}

.file-list {
  max-height: none;
  overflow-y: visible;
  list-style: none;
  padding: 0;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  position: absolute;
  top: 20px;
  left: 250px;
}

.school-logo {
  width: 50px;
  height: auto;
}

.upload-icon {
  font-size: 90px;
  color: #333;
}

.upload-btn {
  margin-top: 30px;
  padding: 12px 24px;
  background-color: #2563eb;
  color: white;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.upload-btn:hover {
  background-color: #1e40af;
}

.upload-btn:disabled {
  background-color: #a0aec0;
  cursor: not-allowed;
}
</style>
